<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Estadísticas Anuales de Partida del Usuario</title>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">

    <style>
        .table td, .table th { padding: 0.5rem; }
    </style>
</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">
    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
            </li>
        </ul>
    </nav>
    
    <div class="content-wrapper" style="min-height: 80vh;">
        <div class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1 class="m-0 text-dark">Estadísticas Anuales de Partida</h1>
                    </div>
                    <div class="col-sm-6">
                        <ol class="breadcrumb float-sm-right">
                            <li class="breadcrumb-item"><a href="#">Inicio</a></li>
                            <li class="breadcrumb-item active">Anual</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="content">
            <div class="container-fluid">
                
                <div class="row mb-3">
                    <div class="col-12 col-md-4">
                        <div class="input-group">
                            <input type="number" id="user-id-input" class="form-control" placeholder="Ingrese ID de Usuario" value="1" min="1">
                            <div class="input-group-append">
                                <button class="btn btn-primary" type="button" id="load-stats-button">
                                    <i class="fas fa-search"></i> Cargar Estadísticas
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="loading-message" class="alert alert-info text-center">Esperando ID de Usuario...</div>
                
                <div id="dynamic-view-container" style="display:none;">

                    <div id="resumen-total" class="row"></div>
                    
                    <div class="row">
                        <div class="col-12">
                            <div id="stats-card" class="card card-info card-outline">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="fas fa-calendar-alt mr-1"></i>
                                        Estadísticas Mensuales del Año 
                                        <span id="current-year" class="badge badge-info ml-2">2025</span>
                                    </h3>
                                    <div class="card-tools">
                                        <button id="prev-year" class="btn btn-sm btn-outline-info" disabled>
                                            <i class="fas fa-arrow-left"></i> Anterior
                                        </button>
                                        <button id="next-year" class="btn btn-sm btn-outline-info">
                                            Siguiente <i class="fas fa-arrow-right"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table id="tabla-estadisticas" class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Mes</th>
                                                    <th class="text-center">Juegos Totales</th>
                                                    <th class="text-center text-success">Victorias</th>
                                                    <th class="text-center text-danger">Derrotas</th>
                                                    <th class="text-center text-warning">Empates</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                            <tfoot>
                                                <tr class="bg-light">
                                                    <th>Total Anual</th>
                                                    <th id="total-juegos-anual" class="text-center">0</th>
                                                    <th id="total-victorias-anual" class="text-center text-success">0</th>
                                                    <th id="total-derrotas-anual" class="text-center text-danger">0</th>
                                                    <th id="total-empates-anual" class="text-center text-warning">0</th>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="main-footer">Desarrollado con <strong>AdminLTE</strong>.</footer>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>

<script>
    // Variables de configuración
    const BASE_API_URL = '/api/stats/';
    const YEARS = [2025, 2026, 2027, 2028, 2029]; // Mapeo de las 5 filas de la matriz
    const MONTHS = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

    let userData = null; // Almacena los datos del backend
    let currentYearIndex = 0; // Índice de la fila de la matriz a mostrar (0 a 4)

    /**
     * Función que renderiza la tabla para el año actual seleccionado (currentYearIndex).
     */
    function renderYearTable() {
        if (!userData || !userData.Estadisticas || userData.Estadisticas.length === 0) return;

        const currentYearStats = userData.Estadisticas[currentYearIndex];
        const currentYear = YEARS[currentYearIndex];
        
        const tbody = $('#tabla-estadisticas tbody');
        tbody.empty();
        
        let totalJuegosAnual = 0;
        let totalVictoriasAnual = 0;
        let totalDerrotasAnual = 0;
        let totalEmpatesAnual = 0;

        // 1. Renderizar filas de la tabla (los 12 meses)
        currentYearStats.forEach((stat, monthIndex) => {
            const monthName = MONTHS[monthIndex];
            
            totalJuegosAnual += stat.cantidadResultados;
            totalVictoriasAnual += stat.victorias;
            totalDerrotasAnual += stat.derrotas;
            totalEmpatesAnual += stat.empates;
            
            let htmlRow = `
                <tr>
                    <td><i class="fas fa-calendar-day mr-2"></i> ${monthName}</td>
                    <td class="text-center">${stat.cantidadResultados}</td>
                    <td class="text-center text-success">${stat.victorias}</td>
                    <td class="text-center text-danger">${stat.derrotas}</td>
                    <td class="text-center text-warning">${stat.empates}</td>
                </tr>
            `;
            tbody.append(htmlRow);
        });

        // 2. Actualizar el pie de tabla (Total Anual)
        $('#total-juegos-anual').text(totalJuegosAnual);
        $('#total-victorias-anual').text(totalVictoriasAnual);
        $('#total-derrotas-anual').text(totalDerrotasAnual);
        $('#total-empates-anual').text(totalEmpatesAnual);
        
        // 3. Actualizar el título y controles
        $('#current-year').text(currentYear);
        $('#prev-year').prop('disabled', currentYearIndex === 0);
        $('#next-year').prop('disabled', currentYearIndex === YEARS.length - 1);
        $('.card-header h3').text(`Estadísticas Mensuales del Año ${currentYear} para ${userData.Nombre_Usuario}`);
    }

    /**
     * Función que realiza la petición FETCH al endpoint del Backend.
     */
    function cargarEstadisticas(userID) {
        if (!userID || isNaN(userID) || parseInt(userID) <= 0) {
            // Muestra advertencia si el ID no es válido
            $('#loading-message').removeClass('alert-info alert-danger').addClass('alert-warning').html('<strong>Advertencia:</strong> Ingrese un ID de usuario válido.');
            $('#dynamic-view-container').hide();
            return;
        }

        const API_URL = BASE_API_URL + userID;

        // Mostrar mensaje de carga
        $('#loading-message').removeClass('alert-danger alert-warning').addClass('alert-info').html(`Cargando estadísticas históricas para ID: <strong>${userID}</strong>...`);
        $('#dynamic-view-container').hide();

        fetch(API_URL)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: No se encontraron datos históricos para el ID ${userID}.`);
                }
                return response.json(); 
            })
            .then(data => {
                // Almacenar los datos y establecer el año inicial (2025)
                userData = data;
                currentYearIndex = 0; 
                
                // Generar los Info-Boxes globales (solo una vez)
                renderTotalSummary(data);

                // Renderizar la vista del primer año
                renderYearTable();
                
                // Mostrar la interfaz
                $('#loading-message').hide();
                $('#dynamic-view-container').show();
            })
            .catch(error => {
                console.error('Error al obtener los datos:', error);
                $('#loading-message').removeClass('alert-info').addClass('alert-danger').html(`<strong>Error de Carga:</strong> ${error.message}`);
                userData = null;
            });
    }

    /**
     * Función para calcular y renderizar el resumen total (todos los años).
     */
    function renderTotalSummary(data) {
        let totalVictorias = 0;
        let totalDerrotas = 0;
        let totalEmpates = 0;
        let totalJuegos = 0;
        
        data.Estadisticas.forEach(yearStats => {
            yearStats.forEach(monthStat => {
                totalVictorias += monthStat.victorias;
                totalDerrotas += monthStat.derrotas;
                totalEmpates += monthStat.empates;
                totalJuegos += monthStat.cantidadResultados;
            });
        });

        const resumenTotalHTML = `
            <div class="col-lg-3 col-6"><div class="small-box bg-info"><div class="inner"><h3>${totalJuegos}</h3><p>Total Partidas (2025-2029)</p></div><div class="icon"><i class="fas fa-trophy"></i></div></div></div>
            <div class="col-lg-3 col-6"><div class="small-box bg-success"><div class="inner"><h3>${totalVictorias}</h3><p>Total Victorias</p></div><div class="icon"><i class="fas fa-check"></i></div></div></div>
            <div class="col-lg-3 col-6"><div class="small-box bg-danger"><div class="inner"><h3>${totalDerrotas}</h3><p>Total Derrotas</p></div><div class="icon"><i class="fas fa-times"></i></div></div></div>
            <div class="col-lg-3 col-6"><div class="small-box bg-warning"><div class="inner"><h3>${totalEmpates}</h3><p>Total Empates</p></div><div class="icon"><i class="fas fa-equals"></i></div></div></div>
        `;
        $('#resumen-total').html(resumenTotalHTML);
    }
    
    // Event Listeners y Lógica de Navegación
    $(document).ready(function() {
        // Carga inicial y listeners del input
        $('#load-stats-button').on('click', function() {
            const userID = $('#user-id-input').val();
            cargarEstadisticas(userID);
        });
        $('#user-id-input').on('keypress', function(e) {
            if (e.which === 13) { e.preventDefault(); $('#load-stats-button').click(); }
        });
        
        // Cargar las estadísticas por defecto (ID 1)
        const defaultID = $('#user-id-input').val();
        cargarEstadisticas(defaultID);

        // Lógica de navegación por Año (Botones)
        $('#prev-year').on('click', function() {
            if (currentYearIndex > 0) {
                currentYearIndex--;
                renderYearTable();
            }
        });

        $('#next-year').on('click', function() {
            if (currentYearIndex < YEARS.length - 1) {
                currentYearIndex++;
                renderYearTable();
            }
        });
    });
</script>

</body>
</html>